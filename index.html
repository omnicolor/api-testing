<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Testing APIs with Behat and PHPUnit</title>
    <link rel="stylesheet" href="deck.js/core/deck.core.css">
    <link rel="stylesheet" href="deck.js/themes/style/web-2.0.css">
    <link rel="stylesheet" href="deck.js/themes/transition/horizontal-slide.css">
    <link rel="stylesheet" href="deck.js/extensions/status/deck.status.css">
    <link rel="stylesheet" href="google-code-prettify/src/prettify.css">
    <link rel="stylesheet/less" href="styles.less">
    <script src="less-1.3.1.min.js"></script>
    <script src="deck.js/modernizr.custom.js"></script>
</head>

<body>

<section class="slide title">
    <div class="container">
        <h1>Testing APIs</h1>
        <h2>(with Behat and PHPUnit)</h2>
        <h3>Omni Adams</h3>
    </div>
    <ul class="note">
        <li>SPEAK UP</li>
    </ul>
</section>

<section class="slide what-youll-learn">
    <h1>What you'll <span>(hopefully)</span> learn</h1>
    <ul class="note">
        <li>start with testing an API with PHPUnit and CURL</li>
        <li>have a brief discussion about doing this locally</li>
        <li>finish with building tests in Behat</li>
        <li>and how to use these tests to guide your API development</li>
    </ul>
</section>

<section class="slide what-youll-learn">
    <h1>What you'll <span>(accidentally)</span> learn</h1>
    <ul class="note">
        <li>I assume you already are familiar with some things</li>
        <li>What an API is</li>
        <li>How to run PHPUnit</li>
        <li>How to run Behat</li>
        <li>if you're not already familiar with them</li>
        <li>I take no responsibility for you accidentally learning</li>
    </ul>
</section>

<section class="slide what-youll-learn">
    <h1>What you'll <span>(probably not)</span> learn</h1>
    <ul class="note">
        <li>You won't learn how to write <strong>unit</strong> tests</li>
        <li>or an API</li>
        <li>or integration tests</li>
    </ul>
</section>

<section class="slide what-youll-learn">
    <h1>What you'll <span>(definitely not)</span> learn</h1>
    <ul class="note">
        <li>We won't mention Selenium</li>
        <li>or how to test front end UI at all</li>
    </ul>
</section>

<section class="slide">
    <h1 class="title">Testing with PHPUnit and cURL</h1>
    <img alt="FoxyCart" class="centered" src="images/foxycart.png">
    <ul class="note">
        <li>Let's start with a simple PHPUnit test</li>
        <li>This may be how you start trying to test your APIs</li>
        <li>And there's nothing really wrong with this</li>
        <li>But you'll hopefully see that Behat makes it easier</li>
        <li>To show how this stuff works, we're going to use FoxyCart</li>
        <li>I'm not affiliated with FoxyCart in any way</li>
        <li>I just think their hypermedia API is well thought out</li>
        <li>As opposed to many APIs, which make you want to &rarr; drink IPAs</li>
    </ul>
</section>

<section class="slide">
    <h1 class="title">APIs versus IPAs</h1>
    <a href="http://steelstringbrewery.com/wp-content/uploads/2012/08/ipa.jpg">
        <img alt="IPA" class="centered" height="600" src="images/ipa.jpg">
    </a>
    <ul class="note">
        <li>&hellip; drink IPAs</li>
        <li>Let's jump right in to FoxyCart's hypermedia API</li>
        <li>and test what happens when we make a GET request</li>
        <li>We'll look at a few of the things you might test</li>
        <li>like response codes, headers, and content</li>
    </ul>
</section>

<section class="slide">
    <h1 class="title">Testing with PHPUnit and cURL</h1>
    <pre class="prettyprint">
function testBareGet() {
    $ch = curl_init(
        'https://api-sandbox.foxycart.com'
    );
    curl_setopt($ch, CURLOPT_RETURNTRANSFER,
        true);
    curl_exec($ch);
    $info = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $this-&gt;assertEquals(400, $info);
}</pre>
    <ul class="note">
        <li>This PHPUnit test sets up a cURL request to the root URL</li>
        <li>and doesn't set any headers or send any data</li>
        <li>FoxyCart has a required header that you must send</li>
        <li>So this is a bad request</li>
        <li>It returns HTTP 400 to tell us we messed up</li>
    </ul>
</section>

<section class="slide">
    <h1 class="title">HTTP Status Codes</h1>
    <dl class="centered">
        <dt>1xx</dt>
        <dd>more information</dd>
        <dt>2xx</dt>
        <dd>it's all good</dd>
        <dt>3xx</dt>
        <dd>you're lost, let us help</dd>
        <dt>4xx</dt>
        <dd>you really messed up</dd>
        <dt>5xx</dt>
        <dd>not your fault, we broke things</dd>
    </dl>
    <ul class="note">
        <li>Here's a list of status code categories</li>
        <li>and what they mean</li>
        <li>100 is used for chunking, caching, or opening web sockets mainly</li>
        <li>200 means things are working, and tell how it succeeded</li>
        <li>300 means the client should look somewhere else</li>
        <li>400 means the server doesn't understand the client</li>
        <li>or the client is asking a bad question</li>
        <li>500 means the server is messed up</li>
    </ul>
</section>

<section class="slide">
    <h1 class="title">Testing with PHPUnit and cURL</h1>
    <pre class="prettyprint">
function testBareGet() {
<span class="highlight">    $ch = curl_init(
        'https://api-sandbox.foxycart.com'
    );
    curl_setopt($ch, CURLOPT_RETURNTRANSFER,
        true);
    curl_exec($ch);</span>
    $info = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $this-&gt;assertEquals(400, $info);
}</pre>
    <ul class="note">
        <li>Using cURL <strong>will</strong> work to test this API</li>
        <li>However, you end up with this boilerplate code</li>
        <li>You'll either have to abstract it out or repeat it</li>
        <li>Obviously, neither of those are particularly great</li>
        <li>But let's continue with a few more PHPUnit tests</li>
        <li>and test some other pieces of this API endpoint</li>
    </ul>
</section>

<section class="slide">
    <h1 class="title">Testing with PHPUnit and cURL</h1>
    <pre class="prettyprint">
function testContentTypeOnError() {
    $ch = curl_init(
        'https://api-sandbox.foxycart.com/');
    curl_setopt($ch, CURLOPT_RETURNTRANSFER,
        true);
    curl_exec($ch);
    $info = curl_getinfo($ch,
        CURLINFO_CONTENT_TYPE);
    $this-&gt;assertEquals(
        'application/vnd.error+json', $info);
}</pre>
    <ul class="note">
        <li>Here's a test for checking the content type</li>
        <li>You can see that it's <strong>very</strong> similar to the last one</li>
        <li>It uses curl_getinfo() to check the content-type header</li>
        <li>Easy enough, right?</li>
        <li>But what if you want to test other headers?</li>
    </ul>
</section>

<section class="slide">
    <h1 class="title">Testing with PHPUnit and cURL</h1>
    <pre class="prettyprint">
function testCacheControlHeader() {
    $ch = curl_init(&hellip;);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER,
        true);
    curl_setopt($ch, CURLOPT_HEADER, true);
    $output = curl_exec($ch);
    $this-&gt;assertContains('Cache-Control: no-cache',
        $output);
}</pre>
    <ul class="note">
        <li>For the sake of argument</li>
        <li>let's check the cache-control header</li>
        <li>Cache control isn't exposed from curl_getinfo</li>
        <li>So we have to just check the header strings</li>
        <li>by &rarr; including them in the output</li>
    </ul>
</section>

<section class="slide">
    <h1 class="title">Testing with PHPUnit and cURL</h1>
    <pre class="prettyprint">
function testCacheControlHeader() {
    $ch = curl_init(&hellip;);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER,
        true);
    <span class="highlight">curl_setopt($ch, CURLOPT_HEADER, true);</span>
    $output = curl_exec($ch);
    $this-&gt;assertContains('Cache-Control: no-cache',
        $output);
}</pre>
    <ul class="note">
        <li>&hellip; including them in the output</li>
        <li>And seeing if they exist there</li>
        <li>Again, obviously not ideal</li>
        <li>But it <strong>will</strong> work</li>
    </ul>
</section>

<section class="slide">
    <h1 class="title">Testing with PHPUnit and cURL</h1>
    <pre class="prettyprint">
public function testOutputContainsErrorMessage() {
    $ch = curl_init(&hellip;);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER,
        true);
    $output = curl_exec($ch);
    $this-&gt;assertContains(
        'FOXYCART-API-VERSION request header',
        $output);
}</pre>
    <ul class="note">
        <li>Here we're checking the content of the API's output</li>
        <li>This shows another problem with doing it this way</li>
        <li>You can't really tell the difference between headers</li>
        <li>and the content returned by the API</li>
    </ul>
</section>

<section class="slide">
    <h1 class="title">Testing with PHPUnit and cURL</h1>
    <pre class="prettyprint">
public function testOutputAsJson() {
    $ch = curl_init(&hellip;);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER,
        true);
    $output = curl_exec($ch);
    $output = json_decode($output);
    $this-&gt;assertContains(
        'FOXYCART-API-VERSION request header',
        $output[0]-&gt;message);
}</pre>
    <ul class="note">
        <li>One way to get around that particular problem</li>
        <li>Parse the response as JSON</li>
        <li>This is a bit more explicit,</li>
        <li>finding the message where we expect it in the output</li>
    </ul>
</section>

<section class="slide">
    <h1 class="title">Testing with PHPUnit and cURL</h1>
    <pre class="cli">
api-testing(200) /$ phpunit apiTest.php
PHPUnit 3.7.28 by Sebastian Bergmann.

.....

Time: 1.21 seconds, Memory: 2.75Mb

OK (5 tests, 5 assertions)</pre>
    <ul class="note">
        <li>Here's the PHPUnit output when we run our five tests</li>
        <li>Only five tests</li>
        <li>and our suite already takes over a second to run</li>
        <li>If we were to include these tests with our unit tests</li>
        <li>this would probably convince devs to stop running them</li>
        <li>after all, slow &rarr; tests are unrun tests</li>
    </ul>
</section>

<section class="slide">
    <a href="http://sunaj-home.org/photos/galleries/lol_cats/funny-pictures-a-snail-rides-a-turtle-and-together-they-are-extra-slow.jpg">
        <img alt="SLOW" class="centered" src="images/slow.jpg">
    </a>
    <ul class="note">
        <li>&hellip; tests are unrun tests</li>
        <li>So you may want to add a group annotation to these tests</li>
        <li>like integration or slow</li>
        <li>so developers can filter which get run</li>
    </ul>
</section>

<!--
<section class="slide">
    <pre class="prettyprint">
    </pre>
    <ul class="note">
    </ul>
</section>
-->

<p class="deck-status">
	<span class="deck-status-current"></span>
	/
	<span class="deck-status-total"></span>
</p>

<script src="deck.js/jquery-1.7.2.min.js"></script>
<script src="deck.js/core/deck.core.js"></script>
<script src="deck.js/extensions/status/deck.status.js"></script>
<script src="deck.js/extensions/hash/deck.hash.js"></script>
<script src="google-code-prettify/src/prettify.js"></script>
<script src="slides.js"></script>
</body>
</html>
